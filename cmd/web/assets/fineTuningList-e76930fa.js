import{d as Z,x as D,r as f,o as ne,U as S,S as ce,k as w,l as q,m as t,j as e,_ as n,$ as y,n as W,aB as Y,Q as me,Z as N,av as A,z as pe,V as fe,W as i,aE as _e,al as be,am as he,c as X,Y as ee,a0 as ge,at as xe,aA as ye,F as te}from"./utils-01c411e4.js";import{_ as Ve}from"./BaseBreadcrumb.vue_vue_type_style_index_0_lang-51ed0b2c.js";import{_ as le}from"./UiParentCard.vue_vue_type_script_setup_true_lang-76206b3a.js";import{A as se}from"./AlertBlock-fafdffe4.js";import{_ as ve}from"./ConfirmByInput.vue_vue_type_style_index_0_lang-d347f42d.js";import{_ as ke}from"./ConfirmByClick.vue_vue_type_style_index_0_lang-e00d620b.js";import{C as Se}from"./ChipBoolean-fe9e8fcb.js";import{_ as P}from"./Explain.vue_vue_type_style_index_0_lang-c016eb46.js";import{_ as Te}from"./UploadFile.vue_vue_type_script_setup_true_lang-187fe0ae.js";import{V as L}from"./VCol-a8d2bf92.js";import{V as re}from"./VRow-970d1eb0.js";import{c as we,ae,e as Ie,V as ie,a5 as M,_ as ue}from"./index-bb5b6a82.js";import{V as Ce}from"./VTextarea-4511848c.js";import{V as Pe,a as Me,b as Ue,c as $e}from"./VExpansionPanel-a8f53ddb.js";import{V as De}from"./VCheckbox-2f0a6ccc.js";import{V as Be}from"./VForm-d3cbc9ba.js";import{_ as Ee}from"./TaskOverview.vue_vue_type_script_setup_true_lang-916280bc.js";import{t as oe}from"./map-65c378ed.js";import{_ as Le}from"./DialogLog.vue_vue_type_style_index_0_lang-dacd768d.js";import{I as Ae}from"./IconLoader-a867f9f9.js";import{I as Fe}from"./IconCircleCheckFilled-8df58c98.js";import"./IconInfoCircle-18798ea0.js";import"./VAlert-29b6aa02.js";import"./Confirm-e9511438.js";import"./VFileInput-e0a13545.js";import"./TextLog-815467f1.js";var Re=we("alarm","IconAlarm",[["path",{d:"M12 13m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0",key:"svg-0"}],["path",{d:"M12 10l0 3l2 0",key:"svg-1"}],["path",{d:"M7 4l-2.75 2",key:"svg-2"}],["path",{d:"M17 4l2.75 2",key:"svg-3"}]]);const qe=Z({__name:"FileList",props:{purpose:{default:""}},emits:["selected"],setup(I,{emit:B}){const V=I,U=B,a=D({list:[],total:0}),m=f(),_=f(!1),h=async(v={})=>{const[k,g]=await A.get({url:"/files",showLoading:m.value.el,data:{purpose:V.purpose,...v}});g?(a.list=g.list||[],a.total=g.total):(a.list=[],a.total=0)},T=()=>{m.value.query({page:1})},C=v=>{_.value||U("selected",v)};return ne(()=>{h()}),(v,k)=>{const g=S("el-table-column"),x=S("TableWithPager"),E=ce("copy");return w(),q(re,{class:"my-0"},{default:t(()=>[e(L,{cols:"12",lg:"3",md:"4",sm:"6"},{default:t(()=>[e(Te,{"show-loading":"",label:"上传微调文件",purpose:v.purpose,"onUpload:success":T,onLoading:k[0]||(k[0]=p=>_.value=p)},null,8,["purpose"])]),_:1}),e(L,{cols:"12"},{default:t(()=>[e(x,{onQuery:h,ref_key:"tableWithPagerRef",ref:m,"row-class-name":"cursor-pointer",infos:a,height:"400px",onRowClick:C},{default:t(()=>[e(g,{label:"文件名",prop:"filename","min-width":"250px"}),e(g,{label:"文件大小",width:"150px"},{default:t(({row:p})=>[n(y(W(Y).getFileSize(p.size)),1)]),_:1}),e(g,{label:"文件地址",prop:"s3Url","min-width":"400px"},{default:t(({row:p})=>[me((w(),N("span",null,[n(y(p.s3Url),1)])),[[E,p.s3Url]])]),_:1})]),_:1},8,["infos"])]),_:1})]),_:1})}}}),Q=I=>(be("data-v-cc9cd917"),I=I(),he(),I),Ne={class:"orangeTxt"},ze={class:"mx-auto mt-3",style:{width:"540px"}},We=Q(()=>i("label",{class:"required"},"微调文件",-1)),Ye={class:"required"},Qe=Q(()=>i("label",{class:"required"},"训练轮次",-1)),Je=Q(()=>i("label",null,"备注",-1)),je=Q(()=>i("label",null,"Lora ",-1)),Ge={class:"required"},Oe={class:"required"},He={class:"required"},Ke={class:"required"},Ze={class:"required"},Xe={class:"required"},et=Z({__name:"createTaskPane",emits:["submit"],setup(I,{expose:B,emit:V}){const U=D({operateType:"add"}),a=D({fileId:"",baseModel:null,trainEpoch:1,suffix:"",remark:"",trainBatchSize:8,evalBatchSize:32,accumulationSteps:1,procPerNode:2,learningRate:2e-5,modelMaxLength:2048,lora:!1}),m=D({estimateTime:"",readyOnly:!0}),_=f(null),h=V,T=/^\+?[1-9][0-9]*$/,C=f(),v=f(),k=f(),g=f(),x=D({fileId:[l=>!!l||"请选择微调文件"],baseModel:[l=>!!l||"请选择基础模型"],trainEpoch:[l=>p(l,1,512,"请输入训练轮次",!0)],trainBatchSize:[l=>p(l,1,512,"请输入训练批次",!0)],evalBatchSize:[l=>p(l,1,32,"请输入评估批次",!0)],accumulationSteps:[l=>p(l,1,32,"请输入梯度累加步数",!0)],procPerNode:[l=>p(l,1,16,"请输入GPU数量",!0)],learningRate:[l=>p(l,1e-6,1,"请输入学习率")],modelMaxLength:[l=>p(l,1,5e5,"请输入模型最大长度",!0)]}),E=f("");pe(m);const p=(l,o,u,c,$=!1)=>l!==""?l<o?`下限 ${o}`:l>u?`上限 ${u}`:$&&T.test(l)!=!0?"请输入正整数":!0:c;((l,o=300)=>{let u=null;return o==null?f(l):_e((c,$)=>({get(){return c(),l},set(r){u!=null&&(clearTimeout(u),u=null),u=setTimeout(()=>{l=r,$()},o)}}))})(a.trainEpoch);const J=()=>{k.value.show({showActions:!1})},j=l=>{k.value.hide(),_.value=l,a.fileId=l.fileId,R()},G=()=>{_.value=null,a.fileId=""},z=async(l={})=>{const[o,u]=await A.post({...l,showSuccess:!0,url:"/finetuning",data:a});u&&(C.value.hide(),h("submit"))},O=async(l={})=>{const[o,u]=await A.post({...l,showSuccess:!1,url:"/api/finetuning/estimate",data:a});u&&(m.estimateTime=u.time?u.time:"")},H=async(l={})=>{},R=()=>{a.baseModel&&a.fileId.length>0&&a.procPerNode>0&&T.test(String(a.trainEpoch))!=!1&&a.trainEpoch>0&&T.test(String(a.procPerNode))!=!1&&O()},d=l=>{const o=g.value.$el;l.some(c=>o.querySelector(`#${c.id}`))&&(E.value="advancedSetting")},b=({valid:l,errors:o,showLoading:u})=>{l?U.operateType=="add"?z({showLoading:u}):H({showLoading:u}):d(o)};return B({show({title:l,operateType:o}){C.value.show({title:l,refForm:v}),U.operateType=o,o=="add"&&(_.value=null,a.baseModel=null,a.fileId="",a.remark="",a.suffix="",m.estimateTime="")}}),(l,o)=>{const u=S("Select"),c=S("Dialog"),$=S("Pane");return w(),q($,{ref_key:"refPane",ref:C,onSubmit:b},fe({default:t(()=>[i("div",ze,[e(se,{class:"mb-6"},{default:t(()=>[n("微调模型的时间可能会很长，微调完成之后会邮件通知您！")]),_:1}),e(Be,{ref_key:"refForm",ref:v,class:"my-form"},{default:t(()=>[e(ae,{rules:x.fileId,modelValue:a.fileId,"onUpdate:modelValue":o[0]||(o[0]=r=>a.fileId=r),"hide-details":"auto"},{prepend:t(()=>[We]),default:t(()=>[_.value?(w(),q(Ie,{key:0,closable:"",color:"info","onClick:close":G},{default:t(()=>[n(y(_.value.filename),1)]),_:1})):(w(),q(ie,{key:1,color:"info",variant:"outlined",onClick:J},{default:t(()=>[n("选择文件")]),_:1}))]),_:1},8,["rules","modelValue"]),e(u,{placeholder:"请选择基础模型",rules:x.baseModel,modelValue:a.baseModel,"onUpdate:modelValue":o[1]||(o[1]=r=>a.baseModel=r),mapAPI:{url:"/finetuning/base/model"},"hide-details":"auto",onChange:R},{prepend:t(()=>[i("label",Ye,[n("基础模型"),e(P,null,{default:t(()=>[n("基于基础模型进行微调")]),_:1})])]),_:1},8,["rules","modelValue"]),e(M,{type:"number",placeholder:"上限512","hide-details":"auto",rules:x.trainEpoch,modelValue:a.trainEpoch,"onUpdate:modelValue":o[2]||(o[2]=r=>a.trainEpoch=r),modelModifiers:{number:!0},onInput:R},{prepend:t(()=>[Qe]),_:1},8,["rules","modelValue"]),e(M,{type:"text",placeholder:"请输入微调后模型名称的后缀","hide-details":"auto",clearable:"",modelValue:a.suffix,"onUpdate:modelValue":o[3]||(o[3]=r=>a.suffix=r)},{prepend:t(()=>[i("label",null,[n("后缀 "),e(P,null,{default:t(()=>[n("微调后模型名称的后缀，通常微调名称为 ft::{模型}:{渠道}:-{随机}:{后缀}")]),_:1})])]),_:1},8,["modelValue"]),e(Ce,{modelValue:a.remark,"onUpdate:modelValue":o[4]||(o[4]=r=>a.remark=r),modelModifiers:{trim:!0},placeholder:"请输入你微调模型的备注",clearable:""},{prepend:t(()=>[Je]),_:1},8,["modelValue"]),e(ae,null,{default:t(()=>[e(Pe,{ref_key:"refSettingExpansion",ref:g,modelValue:E.value,"onUpdate:modelValue":o[12]||(o[12]=r=>E.value=r)},{default:t(()=>[e(Me,{value:"advancedSetting",elevation:"10"},{default:t(()=>[e(Ue,{class:"text-h6"},{default:t(()=>[n("高级设置")]),_:1}),e($e,{class:"mt-4",eager:""},{default:t(()=>[e(De,{label:"启用Lora",modelValue:a.lora,"onUpdate:modelValue":o[5]||(o[5]=r=>a.lora=r)},{prepend:t(()=>[je]),_:1},8,["modelValue"]),e(M,{type:"number",placeholder:"请输入训练批次",rules:x.trainBatchSize,modelValue:a.trainBatchSize,"onUpdate:modelValue":o[6]||(o[6]=r=>a.trainBatchSize=r),modelModifiers:{number:!0}},{prepend:t(()=>[i("label",Ge,[n("训练批次 "),e(P,null,{default:t(()=>[n("即一次训练所抓取的数据样本数量")]),_:1})])]),_:1},8,["rules","modelValue"]),e(M,{type:"number",placeholder:"请输入评估批次",rules:x.evalBatchSize,modelValue:a.evalBatchSize,"onUpdate:modelValue":o[7]||(o[7]=r=>a.evalBatchSize=r),modelModifiers:{number:!0}},{prepend:t(()=>[i("label",Oe,[n("评估批次 "),e(P,null,{default:t(()=>[n("用于评估的每个 GPU/TPU 核心/CPU 的批量大小")]),_:1})])]),_:1},8,["rules","modelValue"]),e(M,{type:"number",placeholder:"请输入梯度累加步数",rules:x.accumulationSteps,modelValue:a.accumulationSteps,"onUpdate:modelValue":o[8]||(o[8]=r=>a.accumulationSteps=r),modelModifiers:{number:!0}},{prepend:t(()=>[i("label",He,[n("梯度累加步数 "),e(P,null,{default:t(()=>[n("在执行向后/更新传递之前累积梯度的更新步骤数")]),_:1})])]),_:1},8,["rules","modelValue"]),e(M,{type:"number",placeholder:"请输入使用GPU数量",rules:x.procPerNode,modelValue:a.procPerNode,"onUpdate:modelValue":o[9]||(o[9]=r=>a.procPerNode=r),modelModifiers:{number:!0},onInput:R},{prepend:t(()=>[i("label",Ke,[n("使用GPU数量 "),e(P,null,{default:t(()=>[n("使用GPU数量")]),_:1})])]),_:1},8,["rules","modelValue"]),e(M,{type:"number",placeholder:"请输入学习率",rules:x.learningRate,modelValue:a.learningRate,"onUpdate:modelValue":o[10]||(o[10]=r=>a.learningRate=r),modelModifiers:{number:!0},step:1e-5},{prepend:t(()=>[i("label",Ze,[n("学习率 "),e(P,null,{default:t(()=>[n("AdamW 优化器的初始学习率")]),_:1})])]),_:1},8,["rules","modelValue"]),e(M,{type:"number",placeholder:"请输入模型最大长度",rules:x.modelMaxLength,modelValue:a.modelMaxLength,"onUpdate:modelValue":o[11]||(o[11]=r=>a.modelMaxLength=r),modelModifiers:{number:!0}},{prepend:t(()=>[i("label",Xe,[n("模型最大长度 "),e(P,null,{default:t(()=>[n("模型支持的最大上下文长度")]),_:1})])]),_:1},8,["rules","modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},512)]),e(c,{ref_key:"refDialogUpload",ref:k,attach:"",persistent:"","max-width":"1200px","retain-focus":!1},{title:t(()=>[n(" 选择文件 ")]),default:t(()=>[e(qe,{onSelected:j,purpose:"fine-tune"})]),_:1},512)]),_:2},[m.estimateTime?{name:"txtLeft",fn:t(()=>[i("p",Ne,[n(" 预计训练时间："),i("span",null,y(m.estimateTime),1)])]),key:"0"}:void 0]),1536)}}});const tt=ue(et,[["__scopeId","data-v-cc9cd917"]]),lt={class:"tooltip-error-message"},at=Z({__name:"TableTrainStatus",props:{item:{default:()=>({})}},emits:["open:log"],setup(I,{emit:B}){const V=I,U=B,a=X(()=>{var h;return(h=oe[V.item.trainStatus])==null?void 0:h.text}),m=X(()=>{var h;return[(h=oe[V.item.trainStatus])==null?void 0:h.textColor,"d-flex","justify-center","align-center"]}),_=()=>{U("open:log")};return(h,T)=>(w(),N("div",{class:ge(m.value)},[i("span",null,y(a.value),1),["running","success"].includes(V.item.trainStatus)?(w(),N("div",{key:0,class:"link ml-1",onClick:_},"(日志)")):ee("",!0),V.item.trainStatus==="failed"&&V.item.errorMessage?(w(),q(P,{key:1,class:"ml-1"},{default:t(()=>[i("div",lt,y(V.item.errorMessage),1)]),_:1})):ee("",!0)],2))}});const ot=ue(at,[["__scopeId","data-v-297d4594"]]),nt=["onClick"],st=i("span",{class:"text-primary"},"取消",-1),rt=i("br",null,null,-1),it={class:"text-primary font-weight-black"},ut=i("br",null,null,-1),Lt={__name:"fineTuningList",setup(I){const B=[{statusText:"等待中",valueText:"个任务",key:"waitingJobCount",color:"warning",bgColor:"lightwarning",icon:Ae},{statusText:"已完成",valueText:"个微调任务",key:"successJobCount",color:"success",bgColor:"lightsuccess",icon:Fe},{statusText:"总微调时间",valueText:"",key:"totalDurationCount",color:"secondary",bgColor:"lightprimary",icon:Re}],V=xe(),U=f({title:"微调任务"}),a=f([{text:"模型微调",disabled:!1,href:"#"},{text:"微调任务",disabled:!0,href:"#"}]),m=D({fineTunedModel:"",trainStatus:null}),_=D({list:[],total:0}),h=f(),T=f(),C=f(),v=f(),k=D({currentJobId:""}),g=f(),x=f(""),E=d=>{let b=[];const l=d.trainStatus;return b.push({text:"查看",click(){z(d)}}),l==="running"||l==="waiting"?b.push({text:"取消",color:"error",click(){j(d)}}):(l==="failed"||l==="cancel")&&b.push({text:"删除",color:"error",click(){O(d)}}),b},p=async(d={})=>{const[b,l]=await A.get({url:"/finetuning",showLoading:T.value.el,data:{...m,...d}});l?(_.list=l.list||[],_.total=l.total):(_.list=[],_.total=0)},F=()=>{T.value.query({page:1})},J=async({jobId:d})=>{C.value.show();let[b,l]=await A.get({url:`/api/finetuning/${d}`});l&&C.value.setContent(l.trainLog)},j=d=>{k.currentJobId=d.jobId,v.value.show({width:"450px",confirmText:k.currentJobId})},G=async(d={})=>{const[b,l]=await A.delete({...d,showSuccess:!0,url:`/finetuning/${k.currentJobId}/cancel`});l&&(v.value.hide(),T.value.query())},z=({jobId:d})=>{V.push(`/model/fine-tuning/detail?jobId=${d}`)},O=d=>{x.value=d.jobId,g.value.show({width:"400px"})},H=async(d={})=>{const[b,l]=await A.delete({...d,showSuccess:!0,url:`/api/finetuning/${x.value}`});l&&(g.value.hide(),F())},R=()=>{h.value.show({title:"创建微调任务",operateType:"add"})};return ne(()=>{p()}),(d,b)=>{const l=S("Select"),o=S("ButtonsInForm"),u=S("el-tooltip"),c=S("el-table-column"),$=S("router-link"),r=S("ButtonsInTable"),de=S("TableWithPager");return w(),N(te,null,[e(Ve,{title:U.value.title,breadcrumbs:a.value},null,8,["title","breadcrumbs"]),e(le,{class:"mb-3"},{default:t(()=>[e(Ee,{config:B,"request-url":"/finetuning/dashboard"})]),_:1}),e(le,null,{default:t(()=>[e(re,null,{default:t(()=>[e(L,{cols:"12",lg:"3",md:"4",sm:"6"},{default:t(()=>[e(M,{density:"compact",modelValue:m.fineTunedModel,"onUpdate:modelValue":b[0]||(b[0]=s=>m.fineTunedModel=s),label:"请输入关键字","hide-details":"",clearable:"",variant:"outlined",onKeyup:ye(F,["enter"]),"onClick:clear":F},null,8,["modelValue","onKeyup"])]),_:1}),e(L,{cols:"12",lg:"3",md:"4",sm:"6"},{default:t(()=>[e(l,{onChange:F,label:"请选择状态",mapDictionary:{code:"local_trainStatus"},modelValue:m.trainStatus,"onUpdate:modelValue":b[1]||(b[1]=s=>m.trainStatus=s)},null,8,["modelValue"])]),_:1}),e(L,{cols:"12",lg:"3",md:"4",sm:"6"},{default:t(()=>[e(o,null,{default:t(()=>[e(ie,{color:"primary",onClick:R},{default:t(()=>[n("创建微调任务")]),_:1})]),_:1})]),_:1}),e(L,{cols:"12"},{default:t(()=>[e(se,null,{default:t(()=>[n(" GPU资源紧张，暂时只支持同时进行一个微调任务！ ")]),_:1})]),_:1}),e(L,{cols:"12"},{default:t(()=>[e(de,{onQuery:p,ref_key:"tableWithPagerRef",ref:T,infos:_},{default:t(()=>[e(c,{label:"任务ID",width:"180px"},{default:t(({row:s})=>[e(u,{content:"查看详情",placement:"top"},{default:t(()=>[i("span",{class:"link",onClick:K=>z(s)},y(s.jobId),9,nt)]),_:2},1024)]),_:1}),e(c,{label:"基础模型",width:"120px"},{default:t(({row:s})=>[e(u,{effect:"dark",content:"进入聊天操场",placement:"top"},{default:t(()=>[e($,{class:"link",to:{path:"/model/chat-playground",query:{modelName:s.baseModel}}},{default:t(()=>[n(y(s.baseModel),1)]),_:2},1032,["to"])]),_:2},1024)]),_:1}),e(c,{label:"训练轮次",prop:"trainEpoch","min-width":"90px"}),e(c,{label:"Lora"},{default:t(({row:s})=>[e(Se,{modelValue:s.lora,"onUpdate:modelValue":K=>s.lora=K},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(c,{label:"训练状态","min-width":"150px"},{default:t(({row:s})=>[e(ot,{item:s,"onOpen:log":K=>J(s)},null,8,["item","onOpen:log"])]),_:1}),e(c,{label:"训练时长",prop:"trainDuration","min-width":"120px"}),e(c,{label:"训练进度","min-width":"90px"},{default:t(({row:s})=>[i("span",null,y(W(Y).toPercent(s.process,2)),1)]),_:1}),e(c,{label:"模型名称",width:"110px"},{default:t(({row:s})=>[s.trainStatus==="success"?(w(),q($,{key:0,class:"link",to:{path:"/model/model-list",query:{modelName:s.fineTunedModel}}},{default:t(()=>[n(y(s.fineTunedModel),1)]),_:2},1032,["to"])):(w(),N(te,{key:1},[n(" -- ")],64))]),_:1}),e(c,{label:"备注","min-width":"200px","show-overflow-tooltip":""},{default:t(({row:s})=>[n(y(s.remark),1)]),_:1}),e(c,{label:"完成时间","min-width":"160px"},{default:t(({row:s})=>[n(y(s.finishedAt?W(Y).dateFormat(s.finishedAt,"YYYY-MM-DD HH:mm:ss"):"--"),1)]),_:1}),e(c,{label:"创建时间","min-width":"160px"},{default:t(({row:s})=>[n(y(W(Y).dateFormat(s.createdAt,"YYYY-MM-DD HH:mm:ss")),1)]),_:1}),e(c,{label:"操作人",prop:"trainPublisher","min-width":"150px","show-overflow-tooltip":""}),e(c,{label:"操作","min-width":"120px",fixed:"right"},{default:t(({row:s})=>[e(r,{buttons:E(s)},null,8,["buttons"])]),_:1})]),_:1},8,["infos"])]),_:1})]),_:1})]),_:1}),e(Le,{ref_key:"refDialogLog",ref:C},null,512),e(ve,{ref_key:"refConfirmAbort",ref:v,onSubmit:G},{text:t(()=>[n(" 此操作将会"),st,n("正在进行的训练任务"),rt,n(" 任务ID："),i("span",it,y(k.currentJobId),1),ut,n(" 你还要继续吗？ ")]),_:1},512),e(ke,{ref_key:"refConfirmDelete",ref:g,onSubmit:H},{text:t(()=>[n("确定删除此任务？")]),_:1},512),e(tt,{ref_key:"createTaskPaneRef",ref:h,onSubmit:F},null,512)],64)}}};export{Lt as default};
